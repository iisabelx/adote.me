<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. CONFIGURA√á√ÉO DO TEMA ESCURO ---
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const body = document.body;
    const THEME_STORAGE_KEY = 'adoptionMapTheme';
    const loginBtn = document.getElementById('loginBtn');
    
    // Fun√ß√£o para aplicar o tema
    function applyTheme(theme) {
        if (theme === 'dark') {
            body.classList.add('dark');
            themeToggleBtn.textContent = 'Modo Claro ‚òÄÔ∏è';
        } else {
            body.classList.remove('dark');
            themeToggleBtn.textContent = 'Modo Escuro üåô';
        }
    }

    // Carregar tema salvo ou usar prefer√™ncia do sistema
    const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (savedTheme) {
        applyTheme(savedTheme);
    } else if (prefersDark) {
        applyTheme('dark');
    } else {
        applyTheme('light');
    }

    // Listener para o bot√£o de altern√¢ncia
    themeToggleBtn.addEventListener('click', () => {
        const newTheme = body.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(newTheme);
        localStorage.setItem(THEME_STORAGE_KEY, newTheme);
        
        // Atualiza a camada do mapa ao mudar o tema
        if (map) {
            updateMapTileLayer(newTheme);
        }
    });

    // --- 2. CONFIGURA√á√ÉO DE LOGIN (Simples) ---
    const MODAL_ACTIVE_CLASS = 'active';
    let isLoggedIn = false;

    // Criar e adicionar o Modal de Login ao DOM
    const modalHTML = `
        <div class="modal-bg" id="loginModal">
            <div class="modal-login">
                <h2>Acesso de Protetor/ONG</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="modalEmail">Email:</label>
                        <input id="modalEmail" type="email" required />
                    </div>
                    <div class="form-group">
                        <label for="modalPassword">Senha:</label>
                        <input id="modalPassword" type="password" required />
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-modal">Entrar</button>
                        <button type="button" class="btn-modal" id="closeModalBtn" style="background: #6c757d;">Fechar</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    const loginModal = document.getElementById('loginModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const loginForm = document.getElementById('loginForm');
    
    // Evento para abrir o modal de login
    loginBtn.addEventListener('click', () => {
        if (isLoggedIn) {
            // Se j√° estiver logado, faz logout
            isLoggedIn = false;
            loginBtn.textContent = 'Login';
            loginBtn.classList.remove('logged');
            document.getElementById('adoptionFormSection').style.display = 'none';
            document.getElementById('toggleViewBtn').style.display = 'none';
            document.getElementById('sensorInfoSection').style.display = 'block';
            alert('Logout realizado com sucesso!');
        } else {
            // Se n√£o estiver logado, abre o modal
            loginModal.classList.add(MODAL_ACTIVE_CLASS);
        }
    });
    
    // Evento para fechar o modal
    closeModalBtn.addEventListener('click', () => {
        loginModal.classList.remove(MODAL_ACTIVE_CLASS);
    });

    // Evento de submiss√£o do formul√°rio de login (simulado)
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        // Simula√ß√£o de login: sucesso se o email for 'ong@adocao.com' e senha '123'
        const email = document.getElementById('modalEmail').value;
        const password = document.getElementById('modalPassword').value;
        
        if (email === 'ong@adocao.com' && password === '123') {
            isLoggedIn = true;
            loginModal.classList.remove(MODAL_ACTIVE_CLASS);
            loginBtn.textContent = 'Logout';
            loginBtn.classList.add('logged');
            document.getElementById('adoptionFormSection').style.display = 'block';
            document.getElementById('toggleViewBtn').style.display = 'block';
            document.getElementById('sensorInfoSection').style.display = 'none';
            alert('Login de ONG/Protetor realizado com sucesso!');
        } else {
            alert('Email ou senha incorretos. Tente novamente.');
        }
        loginForm.reset();
    });

    // Inicia a aplica√ß√£o com o formul√°rio de cadastro oculto
    document.getElementById('adoptionFormSection').style.display = 'none';
    document.getElementById('toggleViewBtn').style.display = 'none';

    // --- 3. CONFIGURA√á√ÉO DOS SENSORES (Simula√ß√£o) ---
    // A API de Sensores s√≥ funciona em ambientes seguros (HTTPS) e √© limitada em navegadores.
    // Simula√ß√£o dos dados:
    document.getElementById('location').textContent = '48.8584, 2.2945 (Torre Eiffel)';
    document.getElementById('compass').textContent = 'Norte (0¬∞ Simulado)';
    document.getElementById('motion').textContent = 'Eixo Z: 9.8 m/s¬≤ (Gravidade)';
    document.getElementById('light').textContent = '85 lux (Ambiente Interno)';
    
    // Oculta a se√ß√£o de sensores inicialmente para dar lugar ao mapa em telas grandes
    document.getElementById('sensorInfoSection').style.display = 'block';


    // --- 4. CONFIGURA√á√ÉO DO MAPA (Leaflet) ---
    let map = null;
    let markerLayer = new L.LayerGroup();
    let currentAdoptionMarker = null;

    // Coordenadas iniciais (S√£o Paulo, Brasil)
    const initialCoords = [-23.5505, -46.6333]; 

    // Fun√ß√£o para definir a camada de mapa base (Tiles)
    function getMapTileLayer(theme) {
        const isDark = theme === 'dark';
        const attribution = '¬© OpenStreetMap contributors';
        
        // Tiles para modo claro (padr√£o)
        let url = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'; 
        
        // Tiles para modo escuro (alternativa)
        if (isDark) {
            url = 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png'; 
            // Necess√°rio adicionar a atribui√ß√£o correta para o Stadia Maps
            return L.tileLayer(url, {
                maxZoom: 20,
                attribution: '&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors'
            });
        }

        return L.tileLayer(url, {
            maxZoom: 19,
            attribution: attribution
        });
    }
    
    // Inicializa o mapa
    function initializeMap() {
        map = L.map('map').setView(initialCoords, 10);
        map.addLayer(markerLayer);
        updateMapTileLayer(body.classList.contains('dark') ? 'dark' : 'light');

        // Evento de clique no mapa para definir a localiza√ß√£o de um novo ponto
        map.on('click', function(e) {
            if (isLoggedIn && document.getElementById('adoptionFormSection').style.display !== 'none') {
                const lat = e.latlng.lat.toFixed(6);
                const lon = e.latlng.lng.toFixed(6);
                document.getElementById('adoptionLat').value = lat;
                document.getElementById('adoptionLon').value = lon;
                
                // Remove marcador tempor√°rio anterior, se existir
                if (currentAdoptionMarker) {
                    currentAdoptionMarker.remove();
                }
                
                // Adiciona novo marcador tempor√°rio para o local de cadastro
                const iconHtml = '<span style="color:#17a2b8;">üìç</span>';
                const customIcon = L.divIcon({ className: 'leaflet-div-icon user-icon', html: iconHtml });
                currentAdoptionMarker = L.marker([lat, lon], { icon: customIcon }).addTo(map)
                    .bindPopup('Novo Ponto de Ado√ß√£o aqui.');
            }
        });
    }
    
    // Fun√ß√£o para atualizar a camada do mapa (alternar entre claro/escuro)
    let currentTileLayer = null;
    function updateMapTileLayer(theme) {
        if (currentTileLayer) {
            map.removeLayer(currentTileLayer);
        }
        currentTileLayer = getMapTileLayer(theme);
        currentTileLayer.addTo(map);
    }

    // Inicializa o mapa
    initializeMap();


    // --- 5. GEST√ÉO DOS PONTOS DE ADO√á√ÉO (Simula√ß√£o) ---
    let adoptionPoints = JSON.parse(localStorage.getItem('adoptionPoints')) || [
        { id: 1, name: 'ONG Cora√ß√£o de Bicho', lat: -23.5878, lon: -46.6565, date: '2025-10-12', time: '10:00', animals: [{ name: 'Doguinho Rex', info: 'Vira-lata, 2 anos, adora crian√ßas.' }, { name: 'Gato Miau', info: 'Siam√™s, 1 ano, castrado.' }] },
        { id: 2, name: 'Feira Petz Aclima√ß√£o', lat: -23.5702, lon: -46.6346, date: '2025-10-19', time: '14:30', animals: [{ name: 'Cadelinha Pipa', info: 'Poodle, 5 anos, d√≥cil, resgatada.' }] }
    ];

    // Fun√ß√£o para mostrar os pontos no mapa
    function renderAdoptionMarkers() {
        markerLayer.clearLayers();
        adoptionPoints.forEach(point => {
            const animalListHtml = point.animals.map(a => `<li><strong>${a.name}</strong>: ${a.info}</li>`).join('');
            
            let popupContent = `
                <div style="font-family: Arial, sans-serif; font-size: 0.95rem;">
                    <h4 style="margin-bottom: 5px; color: #4facfe;">${point.name}</h4>
                    <p style="margin-bottom: 8px;"><strong>üìÖ Data/Hora:</strong> ${new Date(point.date + 'T' + point.time).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' })}</p>
                    <p style="margin-bottom: 4px; font-weight: bold;">Animais para Ado√ß√£o:</p>
                    <ul style="padding-left: 20px; margin-bottom: 8px; list-style-type: disc;">${animalListHtml}</ul>
                    ${isLoggedIn ? `<button class="popup-delete-btn" data-id="${point.id}">Excluir Ponto</button>` : ''}
                </div>
            `;

            const iconHtml = '<span style="color:#28a745;">üêæ</span>';
            const customIcon = L.divIcon({ className: 'leaflet-div-icon adoption-icon', html: iconHtml });

            L.marker([point.lat, point.lon], { icon: customIcon, pointId: point.id })
                .bindPopup(popupContent)
                .addTo(markerLayer);
        });
        
        // Adiciona listener para o bot√£o de exclus√£o
        markerLayer.eachLayer(layer => {
            layer.on('popupopen', function() {
                const deleteBtn = document.querySelector(`.popup-delete-btn[data-id="${layer.options.pointId}"]`);
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        deleteAdoptionPoint(layer.options.pointId);
                        layer.closePopup();
                    });
                }
            });
        });
    }

    // Fun√ß√£o para excluir um ponto
    function deleteAdoptionPoint(id) {
        if (confirm('Tem certeza que deseja excluir este ponto de ado√ß√£o?')) {
            adoptionPoints = adoptionPoints.filter(p => p.id !== id);
            localStorage.setItem('adoptionPoints', JSON.stringify(adoptionPoints));
            renderAdoptionMarkers();
            document.getElementById('formStatus').textContent = 'Ponto de ado√ß√£o removido.';
            setTimeout(() => document.getElementById('formStatus').textContent = '', 3000);
        }
    }
    
    // Renderiza os pontos de ado√ß√£o iniciais
    renderAdoptionMarkers();


    // --- 6. GEST√ÉO DO FORMUL√ÅRIO DE CADASTRO ---
    
    const adoptionForm = document.getElementById('adoptionForm');
    const animalListDiv = document.getElementById('animalList');
    const addAnimalBtn = document.getElementById('addAnimalBtn');
    const formStatus = document.getElementById('formStatus');

    // Fun√ß√£o para criar uma nova entrada de animal no formul√°rio
    function createAnimalEntry() {
        const newEntry = document.createElement('div');
        newEntry.className = 'animal-entry';
        newEntry.innerHTML = `
            <div class="form-group">
                <label>Nome do Animal:</label>
                <input class="animalName" name="animalName" type="text" required />
            </div>
            <div class="form-group">
                <label>Info. do Animal:</label>
                <textarea class="animalInfo" name="animalInfo" placeholder="Ra√ßa, idade, temperamento..."></textarea>
            </div>
            <button type="button" class="remove-animal-btn" title="Remover animal" aria-label="Remover animal">&times;</button>
        `;
        animalListDiv.appendChild(newEntry);
        newEntry.querySelector('.remove-animal-btn').addEventListener('click', () => {
            if (animalListDiv.children.length > 1) {
                newEntry.remove();
            } else {
                alert('Pelo menos um animal √© obrigat√≥rio.');
            }
        });
    }

    // Remove o bot√£o de remo√ß√£o da primeira entrada inicial, se for a √∫nica
    if (animalListDiv.children.length > 0) {
        animalListDiv.querySelector('.remove-animal-btn').addEventListener('click', (e) => {
             if (animalListDiv.children.length > 1) {
                e.target.closest('.animal-entry').remove();
            } else {
                alert('Pelo menos um animal √© obrigat√≥rio.');
            }
        });
    }

    addAnimalBtn.addEventListener('click', createAnimalEntry);

    // Evento de submiss√£o do formul√°rio
    adoptionForm.addEventListener('submit', (e) => {
        e.preventDefault();

        // Coleta dados dos animais
        const animalEntries = Array.from(animalListDiv.querySelectorAll('.animal-entry'));
        const animals = animalEntries.map(entry => ({
            name: entry.querySelector('.animalName').value,
            info: entry.querySelector('.animalInfo').value
        })).filter(a => a.name.trim() !== '');

        if (animals.length === 0) {
            formStatus.textContent = 'Por favor, adicione pelo menos um animal.';
            return;
        }

        const newPoint = {
            id: Date.now(), // ID √∫nico baseado no timestamp
            name: document.getElementById('ongName').value,
            lat: parseFloat(document.getElementById('adoptionLat').value),
            lon: parseFloat(document.getElementById('adoptionLon').value),
            date: document.getElementById('eventDate').value,
            time: document.getElementById('eventTime').value,
            animals: animals
        };

        if (!newPoint.lat || !newPoint.lon) {
             formStatus.textContent = 'Por favor, clique no mapa para definir a localiza√ß√£o do ponto.';
             return;
        }

        adoptionPoints.push(newPoint);
        localStorage.setItem('adoptionPoints', JSON.stringify(adoptionPoints));
        renderAdoptionMarkers();
        adoptionForm.reset();
        
        // Reseta as entradas de animais para o estado inicial
        while (animalListDiv.children.length > 1) {
            animalListDiv.removeChild(animalListDiv.lastChild);
        }
        animalListDiv.querySelector('.animalName').value = '';
        animalListDiv.querySelector('.animalInfo').value = '';

        if (currentAdoptionMarker) {
            map.removeLayer(currentAdoptionMarker);
            currentAdoptionMarker = null;
        }

        formStatus.textContent = 'Ponto de ado√ß√£o salvo com sucesso!';
        setTimeout(() => formStatus.textContent = '', 3000);
    });
    
    // Alternar entre formul√°rio e informa√ß√µes do dispositivo (para o usu√°rio logado)
    const toggleViewBtn = document.getElementById('toggleViewBtn');
    toggleViewBtn.addEventListener('click', () => {
        const formSection = document.getElementById('adoptionFormSection');
        const infoSection = document.getElementById('sensorInfoSection');
        
        if (formSection.style.display === 'none') {
            formSection.style.display = 'block';
            infoSection.style.display = 'none';
            toggleViewBtn.textContent = 'Ver Informa√ß√µes do Dispositivo';
        } else {
            formSection.style.display = 'none';
            infoSection.style.display = 'block';
            toggleViewBtn.textContent = 'Cadastrar Novo Ponto de Ado√ß√£o';
        }
    });
    
    // Garante que o formul√°rio comece oculto, mas o bot√£o de altern√¢ncia apare√ßa para quem logar
    document.getElementById('adoptionFormSection').style.display = 'none';

});
</script>
